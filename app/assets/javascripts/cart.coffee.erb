

$(document).ready ->
#  alert "test"
  #callback handler for form submit

  $('form.order-form').submit (e) ->
    $this = $(@)
    $form = $this.closest('form')
    product_id = +$form.find('[name=product_id]').val()
#    $sum = Number.parseInt($('.basket-inner .count-wrap span').text())
    $sum = +$('.basket-inner .count-wrap span').text()

    postData = $(this).serializeArray()
    formURL = $(this).attr('action')

    $.ajax
      url: formURL
      dataType: 'json'
      type: "POST"
      data: postData
      beforeSend: ->
        alert 'begining'
      success: (data) ->
        $cart_items_wrap = $('.cart-items-wrap')
        if data.added_to_existing
          $cart_items_wrap.children().filter("[data-product-id=#{product_id}]").find('input.one-item-quantity').val(data.quantity)
        else
          $item = data['item_template']
          $('.cart-items-wrap').append($item)
          $sum = $sum + 1


          alert 'success'
        count = $cart_items_wrap.children().length
        $('.basket-inner .count-wrap span').text(count)


    e.preventDefault()

  $('form.delete-product').submit (e) ->

    formURL = $(@).attr('action')

    $item = $(@).closest('.one-item')

    $.ajax
      url: formURL
      type: 'delete'
      dataType: 'json'
      beforeSend: ->
        alert 'begin deleting...'
      success: ->
        alert 'succesfull!'
        $item.remove()
      e.preventDefault()
