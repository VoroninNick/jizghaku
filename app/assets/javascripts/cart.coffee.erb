

$(document).ready ->
#  alert "test"
  #callback handler for form submit

  $('form.order-form').submit (e) ->
    $this = $(@)
    $form = $this.closest('form')
    product_id = +$form.find('[name=product_id]').val()
#    $sum = Number.parseInt($('.basket-inner .count-wrap span').text())
    $sum = +$('.basket-inner .count-wrap span').text()

    postData = $(this).serializeArray()
    formURL = $(this).attr('action')

    $wrap =$(@).closest('.one-product-wrap')
    $status_adding = $wrap.find('.price-wrap')

    $.ajax
      url: formURL
      dataType: 'json'
      type: "POST"
      data: postData
      beforeSend: ->
        $status_adding.addClass('y-sending')

      success: (data) ->
        $cart_items_wrap = $('.cart-items-wrap')
        if data.added_to_existing
          $cart_items_wrap.children().filter("[data-product-id=#{product_id}]").find('input.one-item-quantity').val(data.quantity)
        else
          $item = data['item_template']
          $('.cart-items-wrap').append($item)
          $sum = $sum + 1

        setTimeout (->
          $status_adding.removeClass('y-sending')
          $status_adding.addClass('y-success')
        ), 2000
#        setTimeout (->
#          $status_adding.removeClass('y-success')
#        ), 4000
        count = $cart_items_wrap.children().length
        $('.basket-inner .count-wrap span').text(count)

      complete: ->

        setTimeout (->
          $status_adding.removeClass('y-success')
        ), 4000

      error: ->
        setTimeout (->
          $status_adding.removeClass('y-sending')
          $status_adding.addClass('y-error')
        ), 2000

    e.preventDefault()

  $('form.delete-product').submit (e) ->

    formURL = $(@).attr('action')

    $item = $(@).closest('.one-item')

    $.ajax
      url: formURL
      type: 'delete'
      dataType: 'json'
      beforeSend: ->
        alert 'begin deleting...'
      success: ->
        alert 'succesfull!'
        $item.remove()
      e.preventDefault()
