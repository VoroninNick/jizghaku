

$(document).ready ->

#  =========================
# validate form for basket
#  =========================
  $('#basket-information-form').validate()
#    onfocusout: (element) ->
#      if $(element).valid()
#        $(element).removeClass('input-error').addClass 'input-valid'
#      return
#    invalidHandler: (event, validator) ->
#      $.each validator.errorList, (index, error) ->
#        $(error.element).addClass 'input-error'
#        return
#      return
#    showErrors: ->
#      #This function is kept blank so as to hide the default validation messages.
#      return

#  =========================
# login form from basket
#  =========================
  $('p.esb-closed span').click ->
    $wrap = $(@).closest('.enter-in-system-from-basket-wrap')
    $form = $wrap.find('form')

    $form.show()
    $('p.esb-button').removeClass('esb-closed')

  $('.esb-button-close').click ->
    $wrap = $(@).closest('.enter-in-system-from-basket-wrap')
    $form = $wrap.find('form')

    $form.hide()
    $('p.esb-button').addClass('esb-closed')

  $('#basket-information-form input').keyup ->
    if $('#basket-information-form').valid()
      $('.check-validate-status-button').hide()
#  =========================
# cart validation got ot finish step
#  =========================


  $('.check-validate-status-button').click ->
    $wrap = $(@).closest('.basket-modal-wrap')
    $form = $wrap.find('form')

    $address = $form.find("input[name='street-address']").val()
    $phone = $form.find("input[name='phone']").val()
    $email = $form.find("input[name='email']").val()

    if $('#basket-information-form').valid()
      console.log('validated')
#    else
#      alert 'not valid'


#    if $address.length > 0 && $phone.length > 0 && $email.length > 0
#      $(@).hide()
#    else
#      alert 'no valid'

#  =========================
# callback handler for form submit
#  =========================
  $('form.order-form').submit (e) ->
    $this = $(@)
    $form = $this.closest('form')
    product_id = +$form.find('[name=product_id]').val()
#    $sum = Number.parseInt($('.basket-inner .count-wrap span').text())
    $sum = +$('.basket-inner .count-wrap span').text()

    postData = $(this).serializeArray()
    formURL = $(this).attr('action')

    $wrap =$(@).closest('.one-product-wrap')
    $status_adding = $wrap.find('.price-wrap')

    $.ajax
      url: formURL
      dataType: 'json'
      type: "POST"
      data: postData
      beforeSend: ->
        $status_adding.addClass('y-sending')

      success: (data) ->
        $cart_items_wrap = $('.cart-items-wrap')
        if data.added_to_existing
          $cart_items_wrap.children().filter("[data-product-id=#{product_id}]").find('input.one-item-quantity').val(data.quantity)
        else
          $item = data['item_template']
          $('.cart-items-wrap').append($item)
          $sum = $sum + 1

        setTimeout (->
          $status_adding.removeClass('y-sending')
          $status_adding.addClass('y-success')
        ), 2000
#        setTimeout (->
#          $status_adding.removeClass('y-success')
#        ), 4000
        count = $cart_items_wrap.children().length
        $('.basket-inner .count-wrap span').text(count)

      complete: ->

        setTimeout (->
          $status_adding.removeClass('y-success')
        ), 4000

      error: ->
        setTimeout (->
          $status_adding.removeClass('y-sending')
          $status_adding.addClass('y-error')
        ), 2000

    e.preventDefault()

  $('form.delete-product').submit (e) ->

    formURL = $(@).attr('action')

    $item = $(@).closest('.one-item')

    $.ajax
      url: formURL
      type: 'delete'
      dataType: 'json'
      beforeSend: ->
        alert 'begin deleting...'
      success: ->
        alert 'succesfull!'
        $item.remove()
      e.preventDefault()
